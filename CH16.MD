# Taking Stock of Your Usage

分片集合時，您選擇一個或兩個字段用於拆分數據。 此密鑰（一個或多個）稱為分片密鑰。 分片集合後，您將無法更改分片密鑰，因此正確選擇很重要。

要選擇一個好的分片密鑰，您需要了解您的工作量以及分片密鑰將如何分發應用程序的請求。 這可能很難想像，所以請嘗試列出一些示例，或者甚至更好地在具有示例流量的備份數據集上進行嘗試。 本節有很多圖表和說明，但是沒有替代品可以對您自己的數據進行嘗試。

對於您計劃分片的每個集合，請首先回答以下問題：

您打算增長到多少個碎片？三碎片集群比千碎片集群具有更大的靈活性。隨著群集變大，您不應該計劃觸發可能會擊中所有分片的查詢，因此幾乎所有查詢都必須包含分片鍵。

您是否正在努力減少讀取或寫入延遲？ （延遲是指某件事情要花費多長時間；例如，寫入要花費20毫秒，但您需要花費10毫秒。）減少寫入延遲通常需要將請求發送到地理位置更近或更強大的計算機。

您是否要增加讀取或寫入吞吐量？ （吞吐量是指集群可以同時處理多少個請求；例如，集群可以在20毫秒內完成1000次寫入，但是您需要在20毫秒內進行5000次寫入。）提高吞吐量通常涉及添加更多的並行化和確保請求在群集中平均分配。

您是否要增加系統資源（例如，為MongoDB每GB數據提供更多RAM）？如果是這樣，您希望將工作集大小保持盡可能小。

使用這些答案來評估以下分片鍵說明，並確定您正在考慮的分片鍵在您的情況下是否可以正常使用。 它能為您提供所需的目標查詢嗎？ 它會以您需要的方式改變系統的吞吐量或延遲嗎？ 如果您需要一個緊湊的工作台，它可以提供嗎？

# Picturing Distributions

人們選擇拆分數據的最常見方法是通過升序，隨機和基於位置的密鑰。 可以使用其他類型的密鑰，但是大多數用例屬於這些類別之一。 以下各節討論了不同類型的分佈。

## 升序分片鍵

升序分片鍵通常類似於“日期”字段或ObjectId-隨時間穩定增長的任何東西。 自動遞增主鍵是升序字段的另一個示例，儘管該字段在MongoDB中顯示的很少（除非您要從另一個數據庫導入）。

假設我們在一個遞增字段上進行分片，例如使用ObjectIds在集合上進行“ _id”分片。 如果我們對“ _id”進行分片，那麼數據將被分成“ _id”範圍的塊，如圖16-1所示。 這些塊將分佈在我們的三個分片的分片集群中，如圖16-2所示。

假設我們創建一個新文檔。 它在哪一塊？ 答案是范圍從$ maxKey到ObjectId（“ 5112fae0b4a4b396ff9d0ee5”）的塊。 這稱為最大塊，因為它是包含$ maxKey的塊。

如果我們插入另一個文檔，它也將在最大塊中。 實際上，每個後續插入都將進入最大塊！ 每個插入項的“ _id”字段都將比前一個字段更接近無窮大（因為ObjectId始終是遞增的），因此它們都將進入max塊。

這具有幾個有趣的（通常是不受歡迎的）屬性。 首先，您所有的寫操作都將路由到一個分片（本例中為shard0002）。 該塊將是唯一一個成長和分裂的塊，因為它是唯一接收插入的塊。 插入數據時，新的塊將“掉下”該塊，如圖16-3所示。

這種模式通常使MongoDB很難保持塊均勻平衡，因為所有塊都是由一個分片創建的。 因此，MongoDB必須不斷將塊移動到其他分片，而不是糾正分佈更均勻的系統中可能出現的微小失衡。

**note**

在MongoDB 4.2中，自動拆分功能向分片主mongod的移動增加了頂級塊優化，以解決遞增的分片鍵模式。 平衡器將決定在哪個其他分片中放置頂部塊。 這有助於避免僅在一個分片上創建所有新塊的情況。

## Randomly Distributed Shard Keys

在頻譜的另一端是隨機分佈的分片密鑰。 隨機分佈的密鑰可以是用戶名，電子郵件地址，UUID，MD5哈希或數據集中沒有可識別模式的任何其他密鑰。

假設分片密鑰是0到1之間的一個隨機數。我們最終將在各個分片上隨機分配塊，如圖16-4所示。

隨著插入更多數據，數據的隨機性意味著插入應該相當均勻地擊中每個塊。 您可以通過插入10,000個文檔並查看它們的最終位置來證明這一點：

由於寫入是隨機分佈的，因此分片應以大致相同的速率增長，從而限制了需要進行的遷移次數。 隨機分配的分片鍵的唯一缺點是，MongoDB在隨機訪問超出RAM大小的數據方面效率不高。 但是，如果您有能力或不介意性能下降，則隨機鍵可以很好地在整個群集中分配負載。

## Location-Based Shard Keys

基於位置的分片鍵可能是用戶的IP，緯度和經度或地址之類的東西。它們不一定與物理位置字段相關：“位置”可能是將數據分組在一起的更抽象的方式。在任何情況下，基於位置的密鑰都是具有某些相似性的文檔基於此字段落入範圍的密鑰。這對於將數據靠近其用戶並將相關數據保持在磁盤上都非常方便。保持符合GDPR或其他類似數據隱私法規的法律要求也可能是法律。 MongoDB使用分區分區來管理此任務。

**注意**
在MongoDB 4.0.3+中，您可以在分片集合之前定義區域和區域範圍，該集合將為區域範圍和分片鍵值填充塊，並對其進行初始塊分配。這大大降低了分片區域設置的複雜性。

例如，假設我們有一個在IP地址上分片的文檔集合。如圖16-5所示，文檔將根據其IP被組織成塊，並隨機分佈在整個集群中。

如果我們希望將某些塊範圍附加到某些分片，則可以對這些分片進行分區，然後將塊範圍分配給每個分區。 在此示例中，假設我們希望將某些IP塊保留在某些分片上：例如，56。*。*。*（美國郵政服務的IP塊）保留在shard0000和17。*。*。*（Apple的IP塊）上 在shard0000或shard0002上。 我們不在乎其他IP的位置。 我們可以要求平衡器通過設置區域來做到這一點：

當平衡器移動塊時，它將嘗試將那些範圍內的塊移動到這些碎片。 請注意，此過程不是立即進行的。 沒有被區域鍵範圍覆蓋的塊將正常移動。 平衡器將繼續嘗試在碎片之間平均分配塊。

# Shard Key Strategies